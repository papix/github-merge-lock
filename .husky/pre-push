#!/usr/bin/env sh

PROTECTED_BRANCHES="main production"
ENFORCE_PROTECTED_PUSH=1

if [ "${HUSKY_ALLOW_PROTECTED_PUSH:-}" = "1" ]; then
  ENFORCE_PROTECTED_PUSH=0
fi

# Prevent direct push to protected branches
while read -r local_ref local_sha remote_ref remote_sha
do
  if [ "$ENFORCE_PROTECTED_PUSH" -eq 1 ]; then
    case "$remote_ref" in
      refs/heads/*)
        remote_branch=${remote_ref#refs/heads/}
        for protected in $PROTECTED_BRANCHES; do
          if [ "$remote_branch" = "$protected" ]; then
            echo ""
            echo "=================="
            echo "  ERROR: Direct push to '$protected' is not allowed!"
            echo "=================="
            echo ""
            echo "  Please use a pull request instead."
            echo ""
            exit 1
          fi
        done
        ;;
    esac
  fi
done

npm run check:ci && npm run knip && npm test
